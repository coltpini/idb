export default class IDB{constructor({schema:e,storeName:t,v:r}){this.schema=e,this.storeName=t,this.v=r,this.go()}go(){return new Promise((e,t)=>{const r=indexedDB.open(this.storeName,this.v);r.addEventListener("error",e=>t(e.target.error)),r.addEventListener("success",t=>e(t.target.result)),r.addEventListener("upgradeneeded",e=>this.upgrade(e.target.result)),r.addEventListener("blocked",e=>t("blocked"))})}upgrade(e){let t=this.schema[0].options||{};"index"===this.schema[0].type&&(t.keyPath=this.schema[0].name);const r=e.createObjectStore(this.storeName,t);this.schema.filter(e=>"index"===e.type).forEach(e=>r.createIndex(e.name,e.keyPath||e.name,e.options))}getTransaction(e,t="readwrite"){const r=e.transaction(this.storeName,t);return{trx:r,store:r.objectStore(this.storeName)}}put(e){return this.go().then(t=>{const{trx:r,store:s}=this.getTransaction(t);return!Array.isArray(e)&&(e=[e]),e.forEach(e=>s.put(e)),new Promise((e,s)=>{r.oncomplete=(()=>{t.close(),e("completed")}),r.onerror=(e=>s(e.target.error))})})}get(e){return this.go().then(t=>{const{trx:r,store:s}=this.getTransaction(t,"readonly"),n=s.get(e);return new Promise((e,t)=>{n.onsuccess=(()=>e(n.result)),n.onerror=(()=>t("failed to read"))})})}find({index:e,type:t="key"}){return this.go().then(r=>{const{trx:s,store:n}=this.getTransaction(r,"readonly"),o=(e?n.index(e):n).openCursor();return new Promise((e,r)=>{let s=[];o.onsuccess=(r=>{const n=r.target.result;n?(s.push("value"===t?n.value:n.key),n.continue()):e(s)}),o.onerror=(()=>r("finding failed"))})})}delete(e){return this.go().then(t=>{const{trx:r,store:s}=this.getTransaction(t),n=s.delete(e);return new Promise((e,t)=>{n.onsuccess=(()=>e("deleted")),n.onerror=(()=>t("failed to delete"))})})}};